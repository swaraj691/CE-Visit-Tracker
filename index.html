<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CE Visit Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 2rem;
      color: #333;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }

    h2 {
      font-size: 1.6rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #222;
    }

    /* Top controls */
    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 1.5rem;
    }

    .top-controls input,
    .top-controls select,
    .top-controls button {
      padding: 0.6rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .top-controls button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }
    .top-controls button:hover {
      background-color: #0056b3;
    }
    .top-controls .btn-secondary {
      background-color: #6c757d;
    }
    .top-controls .btn-secondary:hover {
      background-color: #495057;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.75rem;
      border: 1px solid #e1e5ea;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background-color: #f1f3f5;
      font-weight: 600;
      color: #333;
    }

    tr:nth-child(even) {
      background-color: #fafafa;
    }

    td button.edit-btn {
      background: none;
      border: none;
      color: #007bff;
      cursor: pointer;
      margin-left: 5px;
      font-size: 0.9rem;
    }

    /* Modal */
    #ackModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    #ackModalContent {
      background: white;
      padding: 20px;
      border-radius: 10px;
      min-width: 320px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>CE Visit Tracker</h2>

    <!-- Top controls -->
    <div class="top-controls">
      <input type="text" id="caseNumber" placeholder="Case Number" maxlength="10">
      <input type="text" id="visitDate" placeholder="DD / MM">
      <input type="time" id="visitTime">
      <input type="text" id="remarks" placeholder="Remarks">
      <button class="btn" onclick="addCase()">Add Case</button>

      <input type="text" id="searchInput" oninput="renderTable()" placeholder="Search...">
      <select id="monthFilter" onchange="renderTable()">
        <option value="all">All Months</option>
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>
      <button class="btn btn-secondary" onclick="toggleSort()">Toggle Sort</button>
      <button class="btn" onclick="downloadExcel()">Download Excel</button>
    </div>

    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>Case Number</th>
          <th>Visit Date & Time</th>
          <th>Remarks</th>
          <th>Engineer Acknowledge</th>
          <th>CE Assisted</th>
        </tr>
      </thead>
      <tbody id="caseTableBody"></tbody>
    </table>

    <div id="pagination" style="text-align:center; margin-top:1rem;"></div>
  </div>

  <!-- Engineer acknowledgement modal -->
  <div id="ackModal">
    <div id="ackModalContent">
      <h3>Select Engineer for Case: <span id="modalCaseNumber" style="color:#007bff;"></span></h3>
      <select id="engineerSelect"></select>
      <div style="margin-top:15px; text-align:right;">
        <button onclick="submitAcknowledgement()" class="btn">Submit</button>
        <button onclick="closeAckModal()" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto" loop></audio>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDLwz9RAWOZRXjUGxFPM2OU2xDpMvNHDMc",
      authDomain: "da-nastorage.firebaseapp.com",
      databaseURL: "https://da-nastorage-default-rtdb.firebaseio.com",
      projectId: "da-nastorage",
      storageBucket: "da-nastorage.appspot.com",
      messagingSenderId: "503955932158",
      appId: "1:503955932158:web:9713ab1a0b2e7acc5c36af"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.auth().signInAnonymously().catch(console.error);
    const db = firebase.database();

    const engineerList = [ "anwesh-kumar.sahoo", "ayush.garg1", "chanakya.t-r", "diksha-charduatta.natekar", "divya.lakhe", "gauresh.pundlikrao-khope", "hungsaming.n-h", "imran-mohammad.khan", "ishika-rakesh.bansal", "ishwari.deepak-bhorekar", "manav.mehra", "naresh-laxman.adpoikar", "nilambari.rajendra-todakari", "raghupathi-raju.addepalli", "rajesh.banik", "ruturaj.varne", "sakshi.pore", "satnamsingh.surendrasing-relusinghani", "sejal-sandip.mhadgut", "shraddha-harshitkumar.wakode", "shruti.mishra", "shweta.pujari", "simran.jilani-sayyad", "gavade.suryakant", "swarali.shashank-tantak", "tazeen.gulrez-sayed", "vaishnavi.mahajan", "vinit.takhtani","rajshree.a-ext", "janhavi.mishra-ext", "prita.ghosh-ext", "shailesh.giri-ext", "vimal.teotia-ext" ];

    let caseData = [], sortAsc = false, ackTargetCase = "";

    function addCase() {
      const cn = caseNumber.value.trim(), vd = visitDate.value.trim(), vt = visitTime.value.trim(), rm = remarks.value.trim();
      if (!cn || !vd || !vt) return alert("Fill all fields.");
      const [dd, mm] = vd.split("/").map(s => s.trim());
      const dt = new Date(`${new Date().getFullYear()}-${mm}-${dd}T${vt}`);
      db.ref("cases/" + cn).set({ caseNumber: cn, visitDateTime: dt.toISOString(), remarks: rm, engineer: "", ceAssisted: "" });
      [caseNumber, visitDate, visitTime, remarks].forEach(el => el.value = "");
    }

    db.ref("cases").on("value", snapshot => {
      caseData = [];
      snapshot.forEach(child => {
        const d = child.val();
        d.visitDateTimeObj = new Date(d.visitDateTime);
        caseData.push(d);
      });
      renderTable();
    });

    function renderTable() {
      const tbody = document.getElementById("caseTableBody");
      const search = document.getElementById("searchInput").value.toLowerCase().trim();
      const monthFilter = document.getElementById("monthFilter").value;
      tbody.innerHTML = "";

      const filtered = caseData.filter(d => {
        const matchesSearch =
          d.caseNumber.toLowerCase().includes(search) ||
          (d.remarks || '').toLowerCase().includes(search) ||
          (d.engineer || '').toLowerCase().includes(search);

        const matchesMonth =
          monthFilter === "all" ||
          d.visitDateTimeObj.getMonth().toString() === monthFilter;

        return matchesSearch && matchesMonth;
      });

      const sorted = [...filtered].sort((a, b) =>
        sortAsc ? a.visitDateTimeObj - b.visitDateTimeObj : b.visitDateTimeObj - a.visitDateTimeObj
      );

      sorted.forEach(data => {
        const row = document.createElement("tr");
        const dt = data.visitDateTimeObj.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
        row.innerHTML = `
          <td>${data.caseNumber} <button class="edit-btn" onclick="editField('${data.caseNumber}', 'caseNumber', '${data.caseNumber}')">ðŸ–‰</button></td>
          <td>${dt} <button class="edit-btn" onclick="editDateTime('${data.caseNumber}', '${data.visitDateTime}')">ðŸ–‰</button></td>
          <td>${data.remarks || ''} <button class="edit-btn" onclick="editField('${data.caseNumber}', 'remarks', '${(data.remarks || '').replace(/'/g, "\\'")}')">ðŸ–‰</button></td>
          <td><button class="btn btn-secondary" onclick="acknowledgeEngineer('${data.caseNumber}')">Acknowledge</button> <span style="margin-left:10px;">${data.engineer || ''}</span></td>
          <td>
            <select onchange="updateCEAssist('${data.caseNumber}', this.value)">
              <option value="">--Select--</option>
              <option value="Yes" ${data.ceAssisted === 'Yes' ? 'selected' : ''}>Yes</option>
              <option value="No" ${data.ceAssisted === 'No' ? 'selected' : ''}>No</option>
              <option value="CE Not reachable" ${data.ceAssisted === 'CE Not reachable' ? 'selected' : ''}>CE Not reachable</option>
              <option value="NA" ${data.ceAssisted === 'NA' ? 'selected' : ''}>NA</option>
            </select>
          </td>`;
        tbody.appendChild(row);
      });
    }

    function updateCEAssist(caseNumber, value) {
      db.ref("cases/" + caseNumber).update({ ceAssisted: value });
    }

    function toggleSort() {
      sortAsc = !sortAsc;
      renderTable();
    }

    function editField(caseNumber, field, currentValue) {
      const updated = prompt(`Edit ${field}:`, currentValue);
      if (updated && updated !== currentValue) {
        db.ref("cases/" + caseNumber).update({ [field]: updated });
      }
    }

    function editDateTime(caseNumber, iso) {
      const current = new Date(iso);
      const newDate = prompt("New date (DD / MM):", `${String(current.getDate()).padStart(2, '0')} / ${String(current.getMonth() + 1).padStart(2, '0')}`);
      const newTime = prompt("New time (HH:MM):", current.toTimeString().slice(0, 5));
      if (!newDate || !newTime) return;
      const [dd, mm] = newDate.split("/").map(s => s.trim());
      const newDT = new Date(`${current.getFullYear()}-${mm}-${dd}T${newTime}`);
      if (!isNaN(newDT.getTime())) db.ref("cases/" + caseNumber).update({ visitDateTime: newDT.toISOString(), engineer: "" });
      else alert("Invalid date/time");
    }

    function acknowledgeEngineer(caseNumber) {
      ackTargetCase = caseNumber;
      document.getElementById("modalCaseNumber").textContent = caseNumber;
      const select = document.getElementById("engineerSelect");
      select.innerHTML = '<option value="">--Select--</option>' + engineerList.map(name => `<option value="${name}">${name}</option>`).join("");
      document.getElementById("ackModal").style.display = "flex";
    }

    function submitAcknowledgement() {
      const engineer = document.getElementById("engineerSelect").value;
      if (!engineer) return alert("Please select an engineer.");
      db.ref("cases/" + ackTargetCase).update({ engineer });
      document.getElementById("ackModal").style.display = "none";
      const sound = document.getElementById("alarmSound");
      sound.pause();
      sound.currentTime = 0;
    }

    function closeAckModal() {
      document.getElementById("ackModal").style.display = "none";
    }

    function downloadExcel() {
      const monthFilter = document.getElementById("monthFilter").value;

      db.ref("cases").once("value").then(snapshot => {
        const data = [];
        snapshot.forEach(child => {
          const item = child.val();
          const visitDate = new Date(item.visitDateTime);

          if (monthFilter !== "all" && visitDate.getMonth().toString() !== monthFilter) return;

          data.push({
            "Case Number": item.caseNumber,
            "Visit Date & Time": visitDate.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }),
            "Remarks": item.remarks || '',
            "Engineer": item.engineer || '',
            "CE Assisted": item.ceAssisted || ''
          });
        });

        if (data.length === 0) {
          alert("No cases available for the selected month.");
          return;
        }

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "CE Visits");

        let fileName = "CE_Visit_Tracker.xlsx";
        if (monthFilter !== "all") {
          const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          fileName = `CE_Visit_Tracker_${monthNames[parseInt(monthFilter)]}.xlsx`;
        }

        XLSX.writeFile(wb, fileName);
      });
    }

    function checkForUnacknowledgedVisits() {
      const now = new Date();
      caseData.forEach(data => {
        if (!data.engineer && data.visitDateTimeObj) {
          const diffMin = Math.floor((data.visitDateTimeObj - now) / 60000);
          if (diffMin <= 10) {
            triggerAlarmAndPopup(data.caseNumber);
          }
        }
      });
    }

    function triggerAlarmAndPopup(caseNumber) {
      const sound = document.getElementById("alarmSound");
      sound.play().catch(console.error);
      ackTargetCase = caseNumber;
      document.getElementById("modalCaseNumber").textContent = caseNumber;
      const select = document.getElementById("engineerSelect");
      select.innerHTML = '<option value="">--Select--</option>' + engineerList.map(name => `<option value="${name}">${name}</option>`).join("");
      document.getElementById("ackModal").style.display = "flex";
    }

    setInterval(checkForUnacknowledgedVisits, 2 * 60 * 1000); // every 2 minutes
  </script>
</body>
</html>


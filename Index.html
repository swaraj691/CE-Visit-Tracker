<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CE Visit Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      font-size: 1rem;
    }
    button {
      width: auto;
      margin-right: 0.5rem;
      margin-top: 1rem;
      cursor: pointer;
    }
    table {
      margin-top: 2rem;
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    .alert {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #f8d7da;
      color: #721c24;
      padding: 1.5rem;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      display: none;
      z-index: 1000;
    }
    .alert button {
      background: #721c24;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
    }
  </style>
</head>

<body onload="checkUserAccess()">
<script>
  function checkUserAccess() {
    const allowedNames = ["swaraj", "raghu", "chanakya", "rugved"];
    let user = prompt("Enter your name:");
    if (!user || !allowedNames.includes(user.trim().toLowerCase())) {
      document.body.innerHTML = "<h2 style='color:red;'>Access Denied</h2>";
    }
  }
</script>

<h2>
  CE Visit Scheduler North America Storage
  <button onclick="toggleSort()" style="font-size: 0.8rem; margin-left: 1rem;">Sort by Visit Date üîΩ</button>
</h2>

<label>Case Number (10 digits):</label>
<input type="text" id="caseNumber" maxlength="10" pattern="\d{10}" placeholder="Enter 10-digit case number">

<label>CE Visit Date (DD / MM):</label>
<input type="text" id="visitDate" placeholder="e.g. 08 / 05">

<label>CE Visit Time:</label>
<input type="time" id="visitTime">

<label>Remarks:</label>
<textarea id="remarks" placeholder="Enter remarks"></textarea>

<button onclick="addCase()">Add Case</button>
<button onclick="downloadExcel()">Download Excel Report</button>

<table>
  <thead>
    <tr>
      <th>Case Number</th>
      <th>Visit Date & Time (IST)</th>
      <th>Remarks</th>
      <th>Status</th>
      <th>Engineer</th>
    </tr>
  </thead>
  <tbody id="caseTableBody"></tbody>
</table>

<div id="alertBox" class="alert">
  <p id="alertText"></p>
  <button onclick="acknowledgeAlert()">Acknowledge</button>
</div>

<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDLwz9RAWOZRXjUGxFPM2OU2xDpMvNHDMc",
    authDomain: "da-nastorage.firebaseapp.com",
    databaseURL: "https://da-nastorage-default-rtdb.firebaseio.com",
    projectId: "da-nastorage",
    storageBucket: "da-nastorage.appspot.com",
    messagingSenderId: "503955932158",
    appId: "1:503955932158:web:9713ab1a0b2e7acc5c36af",
    measurementId: "G-1NMTP5PZ3S"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const cases = [];
  const alertShownFor = new Set();  // Prevent repeat alerts in one instance
  let sortAscending = true;

  firebase.database().ref("cases").orderByChild("createdAt").on("value", snapshot => {
    cases.length = 0;
    snapshot.forEach(childSnapshot => {
      const c = childSnapshot.val();
      c.visitDateTime = new Date(c.visitDateTime);
      c.createdAt = c.createdAt ? new Date(c.createdAt) : null;
      cases.push(c);

      // ALERT HANDLING FOR ALL CLIENTS
      const now = new Date().getTime();
      const timeDiff = c.visitDateTime.getTime() - now;

      if (c.triggered && !c.acknowledged && !alertShownFor.has(c.caseNumber)) {
        showAlert(`‚è∞ CE Visit for Case #${c.caseNumber} is in less than 10 minutes!`);
        alertShownFor.add(c.caseNumber);
      }

      // Optional fallback: if this instance detects the time condition and hasn't been triggered
      if (!c.triggered && !c.acknowledged && timeDiff <= 10 * 60 * 1000 && timeDiff > 0) {
        firebase.database().ref("cases/" + c.caseNumber).update({ triggered: true });
      }
    });

    sortCases();
    updateTable();
  });

  function addCase() {
    const caseNumber = document.getElementById("caseNumber").value.trim();
    const dateStr = document.getElementById("visitDate").value.trim();
    const time = document.getElementById("visitTime").value;
    const remarks = document.getElementById("remarks").value.trim();

    if (!/^\d{10}$/.test(caseNumber)) {
      alert("Case number must be a 10-digit number.");
      return;
    }

    const dateMatch = dateStr.match(/^(\d{2})\s*\/\s*(\d{2})$/);
    if (!dateMatch) {
      alert("Date must be in DD / MM format.");
      return;
    }

    const day = dateMatch[1];
    const month = dateMatch[2];
    if (!time) {
      alert("Time must be filled.");
      return;
    }

    const year = new Date().getFullYear();
    const visitDateTime = new Date(`${year}-${month}-${day}T${time}`);

    if (isNaN(visitDateTime.getTime())) {
      alert("Invalid date/time.");
      return;
    }

    const newCase = {
      caseNumber,
      visitDateTime: visitDateTime.toISOString(),
      remarks,
      acknowledged: false,
      triggered: false,
      engineer: "",
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    firebase.database().ref("cases/" + caseNumber).set(newCase);
    clearForm();
  }

  function clearForm() {
    document.getElementById("caseNumber").value = "";
    document.getElementById("visitDate").value = "";
    document.getElementById("visitTime").value = "";
    document.getElementById("remarks").value = "";
  }

  function updateTable() {
    const tbody = document.getElementById("caseTableBody");
    tbody.innerHTML = "";
    cases.forEach(c => {
      const tr = document.createElement("tr");
      const acknowledgedText = c.acknowledged
        ? "Acknowledged"
        : `<button onclick="manualAcknowledge('${c.caseNumber}')">Acknowledge</button>`;
      tr.innerHTML = `
        <td>${c.caseNumber}</td>
        <td>${c.visitDateTime.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" })}</td>
        <td>${c.remarks}</td>
        <td>${acknowledgedText}</td>
        <td>${c.engineer || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function manualAcknowledge(caseNumber) {
    const engineer = prompt("Enter engineer's name:");
    if (!engineer) return;

    firebase.database().ref("cases/" + caseNumber).update({
      acknowledged: true,
      engineer: engineer
    });
  }

  function sortCases() {
    cases.sort((a, b) => {
      const timeA = a.visitDateTime.getTime();
      const timeB = b.visitDateTime.getTime();
      return sortAscending ? timeA - timeB : timeB - timeA;
    });
  }

  function toggleSort() {
    sortAscending = !sortAscending;
    sortCases();
    updateTable();
    const button = document.querySelector("button[onclick='toggleSort()']");
    button.textContent = sortAscending ? "Sort by Visit Date üîΩ" : "Sort by Visit Date üîº";
  }

  function showAlert(message) {
    document.getElementById("alertText").textContent = message;
    document.getElementById("alertBox").style.display = "block";
    document.getElementById("alertSound").play();
  }

  function acknowledgeAlert() {
    const engineer = prompt("Enter engineer's name:");
    if (!engineer) return;

    cases.forEach(c => {
      if (c.triggered && !c.acknowledged) {
        firebase.database().ref("cases/" + c.caseNumber).update({
          acknowledged: true,
          engineer: engineer
        });
      }
    });

    document.getElementById("alertBox").style.display = "none";
    updateTable();
  }

  function downloadExcel() {
    const data = cases.map(c => ({
      "Case Number": c.caseNumber,
      "Visit DateTime": c.visitDateTime.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" }),
      "Remarks": c.remarks,
      "Acknowledged": c.acknowledged ? "Yes" : "No",
      "Engineer": c.engineer || ""
    }));

    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "CE Visits");
    XLSX.writeFile(workbook, "CE_Visit_Report.xlsx");
  }
</script>
</body>
</html>
